{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Settings</title>
  <link rel="stylesheet" href="{% static 'css/admin_settings.css' %}">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link rel="icon" type="image/png" href="{% static 'images/pmgi.png' %}">
</head>
<body class="{{ theme_mode }} {{ font_size }} {{ layout_spacing }}">
  <header class="page-header">
    <div class="header-left">
      <span class="company-name">PROFESSIONAL MAINTENANCE GROUP, INC. - PMG TIME CENTRAL</span>
    </div>
    <div class="header-right">
      <img src="{% static 'images/pmgi.png' %}" alt="Logo 1" class="header-logo">
      <img src="{% static 'images/sgslogos.png' %}" alt="Logo 2" class="header-logo">
    </div>
  </header>

<div class="main-layout">
  <aside class="sidebar">
    <h3>âš™ Settings</h3>
    <button type="button" class="dashboard-btn" onclick="location.href='{% url 'admin_dashboard' %}'">â¬… Back to Dashboard</button>
    <button type="button" class="account-btn" onclick="location.href='{% url 'admin_settings' %}?section=general'">ðŸ›  General</button>
    <button type="button" class="account-btn" onclick="location.href='{% url 'admin_settings' %}?section=security'">ðŸ”’ Security Settings</button>
    <button type="button" class="account-btn" onclick="location.href='{% url 'admin_settings' %}?section=file'">ðŸ“‚ File Management</button>
    <button type="button" class="account-btn" onclick="location.href='{% url 'admin_settings' %}?section=email'">ðŸ“§ Email</button>
    <button type="button" class="account-btn" onclick="location.href='{% url 'admin_settings' %}?section=backup'">ðŸ’¾ Backup & Restore</button>
    <button type="button" class="account-btn" onclick="location.href='{% url 'admin_settings' %}?section=audit_log'">ðŸ“‹ Audit Log</button>

    <div class="sidebar-footer">
      <p>Welcome, <strong>{{ request.user.username }}</strong></p>
      <div class="header-buttons">
        <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
      </div>
    </div>
  </aside>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <h1>âš™ Admin Settings</h1>
      </div>
    </div>
    <hr>

    <section class="settings-section">
      {% if section == "general" %}
        <h3>General Settings</h3>
        <form method="POST">
          {% csrf_token %}
          {{ general_form.as_p }}
          <button type="submit">Save Changes</button>
        </form>
        {% else %}
      {% if section == "security" %}
        <h3>Security Settings</h3>
        <form method="POST">
          {% csrf_token %}
          {{ security_form.as_p }}
          <button type="submit">Save Changes</button>
        </form>
        {% else %}
        {% if section == "file" %}
        <div style="display: flex; gap: 2rem;">
          <form method="POST" style="flex: 1;">
            {% csrf_token %}
            {{ file_form.as_p }}
            <button type="submit">Save Changes</button>
          </form>
          <div style="flex: 2; max-height: 400px; overflow-y: auto; width: 100%;">
            <h4>Uploaded Files</h4>
            <table>
              <thead>
                <tr>
                  <th>Filename</th>
                  <th>Uploaded At</th>
                  <th>Uploaded By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for file in uploaded_files %}
                <tr>
                  <td><a href="{{ file.file.url }}" target="_blank">{{ file.file }}</a></td>
                  <td>{{ file.uploaded_at|date:"Y-m-d H:i" }}</td>
                  <td>{{ file.uploaded_by.username }}</td>
                  <td>
                    <form method="POST" action="{% url 'delete_uploaded_file' file.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button onclick="return confirm('Are you sure you want to delete this file?');" class="delete-btn">Delete</button>
                    </form>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="3">No files uploaded.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      {% if section == "email" %}
        <h3>Email Settings</h3>
        <form method="POST">
        {% csrf_token %}
        {{ email_form.as_p }}
        {{ email_form.test_email.label_tag }} {{ email_form.test_email }}
        {{ email_form.action }}

        <button type="submit" name="action" value="save" onclick="document.getElementById('id_action').value='save'">Save Changes</button>
        <button type="submit" name="action" value="test" onclick="document.getElementById('id_action').value='test'">Send Test Email</button>
        </form>
        {% else %}
      {% if section == "backup" %}
        <h3>Backup & Restore</h3>

        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" value="backup">
            <button type="submit" class="btn-backup">ðŸ’¾ Run Backup</button>
            </form>

            <form method="POST" enctype="multipart/form-data" style="margin-top: 15px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="restore">
            <label>Select Backup File:</label>
            <input type="file" name="restore_file" required>
            <button type="submit" class="btn-restore">â™» Restore Database</button>
        </form>
        <hr>
        <h4>Recent Backup/Restore Logs</h4>
          <table class="table-container">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Action</th>
            <th>User</th>
            <th>File</th>
            </tr>
        </thead>
        <tbody>
            {% for log in backup_logs %}
            <tr>
                <td>{{ log.timestamp }}</td>
                <td>{{ log.action }}</td>
                <td>{{ log.user.username }}</td>
                <td>
                {% if "Performed system backup:" in log.action %}
                    {% with filename=log.action|cut:"Performed system backup: " %}
                    <a href="{% url 'download_backup' filename %}" target="_blank" rel="noopener noreferrer">Download</a>
                    {% endwith %}
                {% elif "Restored system from" in log.action %}
                    {% with filename=log.action|cut:"Restored system from " %}
                    <a href="{% url 'download_backup' filename %}" target="_blank" rel="noopener noreferrer">Download</a>
                    {% endwith %}
                {% else %}
                    -
                {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">No recent backup/restore actions.</td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
      {% else %}

      {% if section == "audit_log" %}
        <h3>Audit Log</h3>

        <div>
            <table class="table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; margin-top: 15px;">
            <thead>
                <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for log in audit_logs %}
                <tr>
                    <td>{{ log.timestamp }}</td>
                    <td>{{ log.user.username }}</td>
                    <td>{{ log.action }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">No audit logs available.</td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
          {% else %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endif %}
    </section>
  </div>
</div>
</body>
</html>